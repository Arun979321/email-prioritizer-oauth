<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Email Prioritizer â€” Demo</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 20px; }
    h2 { color: #333; }
    .btn {
      background: #0078ff; color: white; border: none;
      padding: 10px 16px; border-radius: 8px; cursor: pointer;
      font-size: 15px; margin-right: 10px;
    }
    .btn:hover { background: #005fcc; }
    .card {
      background: white; border-radius: 10px; padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 12px 0;
    }
    .high { border-left: 6px solid #d9534f; }
    .med { border-left: 6px solid #f0ad4e; }
    .low { border-left: 6px solid #5cb85c; }
    .meta { color: #666; font-size: 0.9em; margin-top: 5px; }
    #info { margin-left: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>AI Email Prioritizer â€” Demo</h2>

  <button id="btnConnect" class="btn">ðŸ”— Connect Gmail</button>
  <button id="btnFetch" class="btn" disabled>Analyze Last 24 Hours</button>
  <span id="info"></span>

  <hr/>
  <div id="results"></div>

<script>
  // Enable fetch button only after successful connection
  async function checkConnection() {
    try {
      const res = await fetch('/emails', { method: 'GET' });
      if (res.ok) {
        document.getElementById('btnFetch').disabled = false;
        document.getElementById('info').textContent = "âœ… Connected to Gmail";
      }
    } catch (err) {
      document.getElementById('info').textContent = "";
    }
  }

  document.getElementById('btnConnect').onclick = () => {
    // Redirect to server OAuth login
    window.location.href = '/login';
  };

  document.getElementById('btnFetch').onclick = async () => {
    const info = document.getElementById('info');
    info.textContent = 'Fetching emails...';
    try {
      const res = await fetch('/emails');
      if (!res.ok) throw new Error("Not authenticated or failed to fetch emails");
      const data = await res.json();

      info.textContent = `Found ${data.count} emails`;
      const container = document.getElementById('results');
      container.innerHTML = '';

      data.emails.forEach(e => {
        const div = document.createElement('div');
        div.className = 'card';
        if (e.priority_score >= 70) div.classList.add('high');
        else if (e.priority_score >= 40) div.classList.add('med');
        else div.classList.add('low');

        div.innerHTML = `
          <strong>${e.subject}</strong>
          <div class="meta">from: ${e.from} â€¢ ${new Date(e.date).toLocaleString()}</div>
          <p>${e.summary || e.body}</p>
          <div class="meta">Category: ${e.category || 'N/A'} (${(e.category_confidence*100 || 0).toFixed(1)}%) â€¢ Score: ${e.priority_score}</div>
        `;
        container.appendChild(div);
      });
    } catch (err) {
      info.textContent = 'Error: ' + err.message;
    }
  };

  // On page load, check if user is already connected
  window.onload = checkConnection;
</script>
</body>
</html>
